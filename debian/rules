#!/usr/bin/make -f
# -*- makefile -*-

DEB_HOST_ARCH ?=$(shell dpkg-architecture -qDEB_HOST_ARCH)

ifeq ($(DEB_HOST_ARCH), i386))
	CFLAGS += -fpie -fno-strict-aliasing -fstack-protector-strong
	CXXFLAGS += -fpie -fno-strict-aliasing -fstack-protector-strong
endif

ifeq ($(DEB_HOST_ARCH), amd64))
	CFLAGS += -fPIE -fno-strict-aliasing -fstack-protector-strong
	CXXFLAGS += -fPIE -fno-strict-aliasing -fstack-protector-strong
endif

LDFLAGS += -pie -Wl,-O1 -Wl,--sort-common -Wl,--as-needed -Wl,-z,now

DEB_HOST_ARCH_OS := $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)

CMAKE_FLAGS = -DUSE_PAM=yes -DUSE_CONSOLEKIT=yes -DBUILD_SHARED_LIBS=no -DBUILD_SLIMLOCK=yes -DHAVE_SYSTEMD=no

ifeq ($(DEB_HOST_ARCH_OS),kfreebsd)
 CMAKE_FLAGS = -DUSE_PAM=yes -DUSE_CONSOLEKIT=yes -DBUILD_SHARED_LIBS=no -DBUILD_SLIMLOCK=no -DHAVE_SYSTEMD=no
endif

ifeq ($(DEB_HOST_ARCH_OS),hurd)
 CMAKE_FLAGS = -DUSE_PAM=yes -DUSE_CONSOLEKIT=yes -DBUILD_SHARED_LIBS=no -DBUILD_SLIMLOCK=no -DHAVE_SYSTEMD=no
endif

%:
	dh $@ --buildsystem=cmake 

override_dh_auto_configure:
	dh_auto_configure -- $(CMAKE_FLAGS)

override_dh_installinit:
	dh_installinit --noscripts
#dh_installinit --no-restart-on-upgrade --no-start \
#		--update-rcd-params="start 99 2 3 4 5 . stop 1 0 1 6 ."

override_dh_installpam:
	dh_installpam --name=slim

override_dh_install:
	dh_install --list-missing

	# pam
	#install -D -m 0644  pam.sample \
		#$(CURDIR)/debian/slim/etc/pam.d/slim
	# remove COPYRIGHT files.
	rm -rf \
		debian/slim/usr/share/slim/themes/devuan-curve/COPYING
